<html>
    <head>
        <title>CrimeDB - Visualization</title>

        <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.6.4/leaflet.css" />
        <script src="http://ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>
        <script src="http://cdn.leafletjs.com/leaflet-0.6.4/leaflet.js"></script>
        <script type="text/javascript" src="http://maps.stamen.com/js/tile.stamen.js?v1.2.3"></script>

        <style type="text/css">
            #map {
                height: 80%;
            }
        </style>

        <script type="text/javascript">
            var GRID_SIZE = 0.01;
            var CITY_HALL = [38.627047, -90.199192];

            $(document).ready(function() {
                var gridColor = function (numCrimes) {
                    var COLORS = [
                        '#000000',
                        '#0000ff',
                        '#00ff00',
                        '#00ffff',
                        '#ff0000',
                        '#ff00ff',
                        '#ffff00',
                        '#ffffff',
                    ];
                    return COLORS[Math.floor(Math.random() * COLORS.length)];
                };

                var crimeLayer = null;
                var drawGrid = function() {
                    var bounds = map.getBounds();
                    $.getJSON('http://api.crimedb.org/crimes?location=[' +
                        bounds.getNorthWest().lat + ',' + bounds.getNorthWest().lng + ':' +
                        bounds.getSouthEast().lat + ',' + bounds.getSouthEast().lng + ']',
                        function (crimeData) {
                            if (crimeLayer) {
                                map.removeLayer(crimeLayer);
                            }

                            crimeLayer = L.geoJson(
                                crimeData.results.map(function(c) {
                                    return {
                                        type: 'Feature',
                                        geometry: {
                                            type: 'Point',
                                            coordinates: [
                                                // XXX: We shouldn't need to reverse these here, but it
                                                //      seems that CrimeDB and Leaflet disagree about the
                                                //      order of here. The GeoJSON spec dictates [lon, lat].
                                                c.location.coordinates[1],
                                                c.location.coordinates[0]
                                            ]
                                        }
                                    };
                                })
                            );
                            map.addLayer(crimeLayer);
                        }
                    );
                };

                var map = L.map('map');
                map.on('load', drawGrid)
                    .on('viewreset', drawGrid)
                    .on('zoomend', drawGrid)
                    .on('moveend', drawGrid)
                    .on('resize', drawGrid);
                map.addLayer(new L.StamenTileLayer('toner-lite'))
                    .setView(CITY_HALL, 14);
            });
        </script>
    </head>

    <body>
        <div id="map"/>
    </body>
</html>
