<html>
    <head>
        <title>CrimeDB - Visualization</title>

        <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.6.4/leaflet.css" />
        <script src="http://ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>
        <script src="http://cdn.leafletjs.com/leaflet-0.6.4/leaflet.js"></script>
        <script type="text/javascript" src="http://maps.stamen.com/js/tile.stamen.js?v1.2.3"></script>

        <style type="text/css">
            #map {
                height: 80%;
            }
        </style>

        <script type="text/javascript">
            var GRID_SIZE = 0.005;
            var CITY_HALL = [38.627047, -90.199192];

            $(document).ready(function() {
                var gridColor = function(numCrimes) {
                    var COLORS = [
                        '#0000ff',
                        '#2000e0',
                        '#4000c0',
                        '#6000a0',
                        '#800080',
                        '#a00060',
                        '#c00040',
                        '#e00020',
                        '#ff0000'
                    ];
                    return COLORS[Math.min(Math.floor(numCrimes / 10), COLORS.length - 1)];
                };

                var crimeDataToGrid = function(mapBounds, crimeData) {
                    /* Construct a data grid for the map, initialized to 0 */
                    var lonSize = Math.ceil(
                        Math.abs(mapBounds.getEast() - mapBounds.getWest()) /
                            GRID_SIZE);
                    var latSize = Math.ceil(
                        Math.abs(mapBounds.getNorth() - mapBounds.getSouth()) /
                            GRID_SIZE);
                    var dataGrid = new Array(lonSize);
                    for (var i = 0; i < lonSize + 1; ++i) {
                        dataGrid[i] = new Array(latSize);
                        for (var ii = 0; ii < latSize + 1; ++ii) {
                            dataGrid[i][ii] = 0;
                        }
                    }

                    /* Fill crime data into the grid */
                    var westBounds = Math.floor(mapBounds.getWest() / GRID_SIZE) * GRID_SIZE;
                    var southBounds = Math.floor(mapBounds.getSouth() / GRID_SIZE) * GRID_SIZE;
                    crimeData.results.forEach(function(c) {
                        var x = Math.floor((c.location.coordinates[0] - westBounds) / GRID_SIZE);
                        var y = Math.floor((c.location.coordinates[1] - southBounds) / GRID_SIZE);
                        ++dataGrid[x][y];
                    });

                    return dataGrid;
                };

                var crimeGridToGeoJson = function(mapBounds, crimeDataGrid) {
                    var w = Math.floor(mapBounds.getWest() / GRID_SIZE) * GRID_SIZE;
                    var s = Math.floor(mapBounds.getSouth() / GRID_SIZE) * GRID_SIZE;

                    return crimeDataGrid.reduce(
                        function(gj, cdColumn, x) {
                            return gj.concat(
                                cdColumn.reduce(
                                    function(gj, cd, y) {
                                        return gj.concat({
                                            type: 'Feature',
                                            properties: {
                                                crimeCount: crimeDataGrid[x][y]
                                            },
                                            geometry: {
                                                type: 'Polygon',
                                                coordinates: [[
                                                    [w + x * GRID_SIZE, s + y * GRID_SIZE],
                                                    [w + x * GRID_SIZE, s + (y + 1) * GRID_SIZE],
                                                    [w + (x + 1) * GRID_SIZE, s + (y + 1) * GRID_SIZE],
                                                    [w + (x + 1) * GRID_SIZE, s + y * GRID_SIZE],
                                                    [w + x * GRID_SIZE, s + y * GRID_SIZE],
                                                ]]
                                            },
                                        });
                                    },
                                    []
                                )
                            );
                        },
                        []
                    );
                };

                var crimeLayer = null;
                var drawGrid = function() {
                    var bounds = map.getBounds();
                    $.getJSON('http://api.crimedb.org/crimes' +
                        '?location=[' +
                            bounds.getNorthWest().lat + ',' + bounds.getNorthWest().lng + ':' +
                            bounds.getSouthEast().lat + ',' + bounds.getSouthEast().lng + ']' +
                        '&limit=1000000' +
                        '&time=[1356998400:1388534400]',
                        function (crimeData) {
                            if (crimeLayer) {
                                map.removeLayer(crimeLayer);
                            }

                            crimeDataGrid = crimeDataToGrid(bounds, crimeData);
                            crimeGeoJson = crimeGridToGeoJson(bounds, crimeDataGrid);

                            crimeLayer = L.geoJson(crimeGeoJson, {
                                style: function (f) {
                                    return {
                                        color: gridColor(f.properties.crimeCount),
                                        stroke: false
                                    };
                                }
                            });
                            crimeLayer.addTo(map);
                        }
                    );
                };

                var map = L.map('map');
                map.on('load', drawGrid)
                    .on('viewreset', drawGrid)
                    .on('zoomend', drawGrid)
                    .on('moveend', drawGrid)
                    .on('resize', drawGrid);
                map.addLayer(new L.StamenTileLayer('toner-lite'))
                    .setView(CITY_HALL, 14);
            });
        </script>
    </head>

    <body>
        <div id="map"/>
    </body>
</html>
