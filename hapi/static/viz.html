<html>
    <head>
        <title>CrimeDB - Visualization</title>

        <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.6.4/leaflet.css" />
        <script src="http://ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>
        <script src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.10.3/jquery-ui.min.js"></script>
        <script src="http://cdn.leafletjs.com/leaflet-0.6.4/leaflet.js"></script>
        <script type="text/javascript" src="http://maps.stamen.com/js/tile.stamen.js?v1.2.3"></script>

        <style type="text/css">
            #map {
                height: 60%;
                width: 80%;
                margin-left: auto;
                margin-right: auto;
                border: 2px solid grey;
            }

            #form {
                width: 80%;
                margin-left: auto;
                margin-right: auto;
            }

            .legend {
                background: white;
                opacity: 1.0;
                padding: 5px;
                margin: 5px;
                border: 1px solid grey;
            }

            .legend .swatch {
                height: 10px;
                width: 10px;
                margin: 3px;
                float: left;
                opacity: 0.4;
            }
        </style>

        <script type="text/javascript">
            var GRID_SIZE = 0.002;
            // http://www.colorbrewer2.org/
            var GRID_COLORS = [
                '#3288BD',
                '#66C2A5',
                '#ABDDA4',
                '#E6F598',
                '#FEE08B',
                '#FDAE61',
                '#F46D43',
                '#D53E4F',
            ];
            var CITY_HALL = [38.627047, -90.199192];
            var QUERY_URL_BASE = 'http://api.crimedb.org/crimes';

            var currentLayer = null;
            var legendLayer = null;
            var currentBounds = null;
            var queryParams = {
                limit: 1000000,
                time: '[1356998400:1388534400]',
            };

            var computePercentileColorBands = function(crimeGrid) {
                if (GRID_COLORS.length != 8) {
                    throw Execption('Update percentile colors!');
                }

                /* Flatten data grid into a sorted array */
                var flatData = crimeGrid.reduce(
                    function(acc, v) { return acc.concat(v); },
                    []
                );
                flatData.sort(function(a, b) { return a - b; });

                /*
                 * Compute bands. Be careful not to overrun flatData.
                 *
                 * These percentiles are totally made up. I kind of doubt
                 * that it's important to be able to compute these for an
                 * arbitrary number of color bands; 8 seems like plenty.
                 */
                var colorBands = new Array(GRID_COLORS.length + 1);
                colorBands[0] = flatData[Math.round(flatData.length * 5 / 100)];
                colorBands[1] = flatData[Math.round(flatData.length * 10 / 100)];
                colorBands[2] = flatData[Math.round(flatData.length * 25 / 100)];
                colorBands[3] = flatData[Math.round(flatData.length * 50 / 100)];
                colorBands[4] = flatData[Math.round(flatData.length * 75 / 100)];
                colorBands[5] = flatData[Math.round(flatData.length * 90 / 100)];
                colorBands[6] = flatData[Math.round(flatData.length * 95 / 100)];
                colorBands[7] = flatData[Math.round(flatData.length * 99 / 100)];
                colorBands[GRID_COLORS.length] = flatData[flatData.length - 1];

                return colorBands;
            };

            var gridColor = function(colorBands, numCrimes) {
                /*
                 * colorBands[i] < val <= colorBands[i + 1] means the
                 * value needs to get colored with GRID_COLORS[i]
                 */
                for (var i = 1; i < colorBands.length; ++i) {
                    if (numCrimes <= colorBands[i]) {
                        return GRID_COLORS[i - 1];
                    }
                }
            };

            var crimeDataToGrid = function(mapBounds, crimeData) {
                /* Construct a data grid for the map, initialized to 0 */
                var lonSize = Math.ceil(
                    Math.abs(mapBounds.getEast() - mapBounds.getWest()) /
                        GRID_SIZE);
                var latSize = Math.ceil(
                    Math.abs(mapBounds.getNorth() - mapBounds.getSouth()) /
                        GRID_SIZE);
                var dataGrid = new Array(lonSize);
                for (var i = 0; i < lonSize + 1; ++i) {
                    dataGrid[i] = new Array(latSize);
                    for (var ii = 0; ii < latSize + 1; ++ii) {
                        dataGrid[i][ii] = 0;
                    }
                }

                /* Fill crime data into the grid */
                var westBounds = Math.floor(mapBounds.getWest() / GRID_SIZE) * GRID_SIZE;
                var southBounds = Math.floor(mapBounds.getSouth() / GRID_SIZE) * GRID_SIZE;
                crimeData.results.forEach(function(c) {
                    var x = Math.floor((c.location.coordinates[0] - westBounds) / GRID_SIZE);
                    x = Math.min(Math.max(x, 0), dataGrid.length - 1);
                    var y = Math.floor((c.location.coordinates[1] - southBounds) / GRID_SIZE);
                    y = Math.min(Math.max(y, 0), dataGrid[0].length - 1);
                    ++dataGrid[x][y];
                });

                return dataGrid;
            };

            var crimeGridToGeoJson = function(mapBounds, crimeDataGrid) {
                var w = Math.floor(mapBounds.getWest() / GRID_SIZE) * GRID_SIZE;
                var s = Math.floor(mapBounds.getSouth() / GRID_SIZE) * GRID_SIZE;

                return crimeDataGrid.reduce(
                    function(gj, cdColumn, x) {
                        return gj.concat(
                            cdColumn.reduce(
                                function(gj, cd, y) {
                                    return gj.concat({
                                        type: 'Feature',
                                        properties: {
                                            crimeCount: crimeDataGrid[x][y]
                                        },
                                        geometry: {
                                            type: 'Polygon',
                                            coordinates: [[
                                                [w + x * GRID_SIZE, s + y * GRID_SIZE],
                                                [w + x * GRID_SIZE, s + (y + 1) * GRID_SIZE],
                                                [w + (x + 1) * GRID_SIZE, s + (y + 1) * GRID_SIZE],
                                                [w + (x + 1) * GRID_SIZE, s + y * GRID_SIZE],
                                                [w + x * GRID_SIZE, s + y * GRID_SIZE],
                                            ]]
                                        },
                                    });
                                },
                                []
                            )
                        );
                    },
                    []
                );
            };

            var drawGrid = function(map) {
                var bounds = map.getBounds();

                // Nothing to do
                if (bounds.equals(currentBounds)) {
                    return;
                }

                currentBounds = bounds;

                // Constrain query results to the location currently visible on the map
                queryParams.location = '[' +
                    bounds.getNorthWest().lat + ',' + bounds.getNorthWest().lng + ':' +
                    bounds.getSouthEast().lat + ',' + bounds.getSouthEast().lng + ']';

                // Compute the query URL
                var url = QUERY_URL_BASE;
                var firstParam = true;
                for (var pn in queryParams) {
                    url += (firstParam) ? '?' : '&';
                    url += pn + '=' + queryParams[pn];
                    firstParam = false;
                }

                $.getJSON(url,
                    function (crimeData) {
                        if (currentLayer) {
                            map.removeLayer(currentLayer);
                        }

                        if (legendLayer) {
                            map.removeLayer(legendLayer);
                            $('.legend').remove();
                        }

                        var crimeDataGrid = crimeDataToGrid(bounds, crimeData);
                        var crimeGeoJson = crimeGridToGeoJson(bounds, crimeDataGrid);
                        var colorBands = computePercentileColorBands(crimeDataGrid);

                        currentLayer = L.geoJson(crimeGeoJson, {
                            style: function (f) {
                                return {
                                    color: gridColor(
                                        colorBands,
                                        f.properties.crimeCount),
                                    fillOpacity: 0.4,
                                    stroke: false
                                };
                            }
                        });
                        currentLayer.addTo(map);

                        legendLayer = L.control({position: 'bottomright'});
                        legendLayer.onAdd = function(map) {
                            var div = L.DomUtil.create('div', 'legend');
                            for (var i = GRID_COLORS.length - 1; i >= 0; --i) {
                                var text = '';

                                if (i == GRID_COLORS.length - 1) {
                                    text = 'above ' + colorBands[i];
                                } else if (i > 0) {
                                    text = colorBands[i - 1] + ' - ' + colorBands[i];
                                } else {
                                    text = 'below ' + colorBands[i];
                                }

                                div.innerHTML +=
                                    '<i class="swatch" ' +
                                        'style="background: ' +
                                        GRID_COLORS[i] +
                                        ';"></i>' + text + '<br/>';
                            }
                            return div;
                        };
                        legendLayer.addTo(map);
                    }
                );
            };

            $(document).ready(function() {
                var map = L.map('map');
                map.on('load', function() { drawGrid(map); })
                    .on('viewreset', function() { drawGrid(map); })
                    .on('zoomend', function() { drawGrid(map); })
                    .on('moveend', function() { drawGrid(map); })
                    .on('resize', function() { drawGrid(map); });
                map.addLayer(new L.StamenTileLayer('toner-lite'))
                    .setView(CITY_HALL, 14);

                $('#submit-button')
                    .button({label: 'Search'})
                    .click(function() {
                        var description = $('#search-text').val().trim();
                        if (description.length > 0) {
                            queryParams.description = description;
                        } else {
                            delete queryParams['description'];
                        }

                        drawGrid(map);
                    });
            });
        </script>
    </head>

    <body>
        <div id="map"></div>
        <div id="form">
            <div style="float: right;">
                <input type="button" style="width: 90px;" id="submit-button"/>
            </div>
            <div style="margin-right: 100px;">
                <input type="text" style="width: 100%;" id="search-text"/>
            </div>
        </div>
    </body>
</html>
