<html>
    <head>
        <title>CrimeDB - Visualization</title>

        <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.6.4/leaflet.css" />
        <script src="http://ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>
        <script src="http://cdn.leafletjs.com/leaflet-0.6.4/leaflet.js"></script>
        <script type="text/javascript" src="http://maps.stamen.com/js/tile.stamen.js?v1.2.3"></script>

        <style type="text/css">
            #map {
                height: 80%;
            }
        </style>

        <script type="text/javascript">
            var GRID_SIZE = 0.002;
            // http://www.colorbrewer2.org/
            var GRID_COLORS = [
                '#3288BD',
                '#66C2A5',
                '#ABDDA4',
                '#E6F598',
                '#FEE08B',
                '#FDAE61',
                '#F46D43',
                '#D53E4F',
            ];
            var CITY_HALL = [38.627047, -90.199192];

            $(document).ready(function() {
                var computePercentileColorBands = function(crimeGrid, numBands) {
                    /* Flatten data grid into a sorted array */
                    var flatData = crimeGrid.reduce(
                        function(acc, v) { return acc.concat(v); },
                        []
                    );
                    flatData.sort(function(a, b) { return a - b; });

                    /* Compute bands. Be careful not to overrun flatData. */
                    var bandSize = flatData.length / numBands;
                    var colorBands = new Array(numBands + 1);
                    for (var i = 0; i < colorBands.length; ++i) {
                        colorBands[i] = flatData[
                            Math.min(
                                Math.round(i * bandSize),
                                flatData.length - 1)];
                    }
                  
                    return colorBands;
                };

                var computeLinearColorBands = function(crimeGrid, numBands) {
                    /* Flatten data grid into a sorted array */
                    var flatData = crimeGrid.reduce(
                        function(acc, v) { return acc.concat(v); },
                        []
                    );
                    flatData.sort(function(a, b) { return a - b; });

                    /* Compute bands. Be careful not to overrun flatData. */
                    var bandSize = flatData[flatData.length - 1] / numBands;
                    var colorBands = new Array(numBands + 1);
                    for (var i = 0; i < colorBands.length; ++i) {
                        colorBands[i] = Math.min(
                            Math.round(i * bandSize),
                            flatData[flatData.length - 1]);
                    }

                    return colorBands;
                };

                var computeGridColorBands = computePercentileColorBands;

                var gridColor = function(colorBands, numCrimes) {
                    /*
                     * colorBands[i] < val <= colorBands[i + 1] means the
                     * value needs to get colored with GRID_COLORS[i]
                     */
                    for (var i = 1; i < colorBands.length; ++i) {
                        if (numCrimes <= colorBands[i]) {
                            return GRID_COLORS[i - 1];
                        }
                    }
                };

                var crimeDataToGrid = function(mapBounds, crimeData) {
                    /* Construct a data grid for the map, initialized to 0 */
                    var lonSize = Math.ceil(
                        Math.abs(mapBounds.getEast() - mapBounds.getWest()) /
                            GRID_SIZE);
                    var latSize = Math.ceil(
                        Math.abs(mapBounds.getNorth() - mapBounds.getSouth()) /
                            GRID_SIZE);
                    var dataGrid = new Array(lonSize);
                    for (var i = 0; i < lonSize + 1; ++i) {
                        dataGrid[i] = new Array(latSize);
                        for (var ii = 0; ii < latSize + 1; ++ii) {
                            dataGrid[i][ii] = 0;
                        }
                    }

                    /* Fill crime data into the grid */
                    var westBounds = Math.floor(mapBounds.getWest() / GRID_SIZE) * GRID_SIZE;
                    var southBounds = Math.floor(mapBounds.getSouth() / GRID_SIZE) * GRID_SIZE;
                    crimeData.results.forEach(function(c) {
                        var x = Math.floor((c.location.coordinates[0] - westBounds) / GRID_SIZE);
                        var y = Math.floor((c.location.coordinates[1] - southBounds) / GRID_SIZE);
                        ++dataGrid[x][y];
                    });

                    return dataGrid;
                };

                var crimeGridToGeoJson = function(mapBounds, crimeDataGrid) {
                    var w = Math.floor(mapBounds.getWest() / GRID_SIZE) * GRID_SIZE;
                    var s = Math.floor(mapBounds.getSouth() / GRID_SIZE) * GRID_SIZE;

                    return crimeDataGrid.reduce(
                        function(gj, cdColumn, x) {
                            return gj.concat(
                                cdColumn.reduce(
                                    function(gj, cd, y) {
                                        return gj.concat({
                                            type: 'Feature',
                                            properties: {
                                                crimeCount: crimeDataGrid[x][y]
                                            },
                                            geometry: {
                                                type: 'Polygon',
                                                coordinates: [[
                                                    [w + x * GRID_SIZE, s + y * GRID_SIZE],
                                                    [w + x * GRID_SIZE, s + (y + 1) * GRID_SIZE],
                                                    [w + (x + 1) * GRID_SIZE, s + (y + 1) * GRID_SIZE],
                                                    [w + (x + 1) * GRID_SIZE, s + y * GRID_SIZE],
                                                    [w + x * GRID_SIZE, s + y * GRID_SIZE],
                                                ]]
                                            },
                                        });
                                    },
                                    []
                                )
                            );
                        },
                        []
                    );
                };

                var currentLayer = null;
                var drawGrid = function() {
                    var bounds = map.getBounds();
                    $.getJSON('http://api.crimedb.org/crimes' +
                        '?location=[' +
                            bounds.getNorthWest().lat + ',' + bounds.getNorthWest().lng + ':' +
                            bounds.getSouthEast().lat + ',' + bounds.getSouthEast().lng + ']' +
                        '&limit=1000000' +
                        '&time=[1356998400:1388534400]',
                        function (crimeData) {
                            if (currentLayer) {
                                map.removeLayer(currentLayer);
                            }

                            var crimeDataGrid = crimeDataToGrid(bounds, crimeData);
                            var crimeGeoJson = crimeGridToGeoJson(bounds, crimeDataGrid);
                            var colorBands = computeGridColorBands(crimeDataGrid, GRID_COLORS.length);

                            currentLayer = L.geoJson(crimeGeoJson, {
                                style: function (f) {
                                    return {
                                        color: gridColor(
                                            colorBands,
                                            f.properties.crimeCount),
                                        fillOpacity: 0.4,
                                        stroke: false
                                    };
                                }
                            });
                            currentLayer.addTo(map);
                        }
                    );
                };

                var map = L.map('map');
                map.on('load', drawGrid)
                    .on('viewreset', drawGrid)
                    .on('zoomend', drawGrid)
                    .on('moveend', drawGrid)
                    .on('resize', drawGrid);
                map.addLayer(new L.StamenTileLayer('toner-lite'))
                    .setView(CITY_HALL, 14);
            });
        </script>
    </head>

    <body>
        <div id="map"/>
    </body>
</html>
