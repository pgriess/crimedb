#!/bin/bash -e
#
# Update the world.

CRIMEDB_ROOT=$(dirname $0)/..

optCrawl=
optPush=
optRender=

usage() {
    cat >&2 <<EOF
usage: $EXEC [options]

Update CrimeDB, running whatever phases are requested. By default, nothing is
done.

Options:
  -c                crawl
  -h                show help
  -p                push
  -r                render
EOF
}

while getopts 'chpr' OPTNAME ; do
    case $OPTNAME in
        c)
            optCrawl=1
            ;;

        h)
            usage
            exit 0
            ;;

        p)
            optPush=1
            ;;

        r)
            optRender=1
            ;;
    esac
done

if [[ -n "$optCrawl" ]] ; then
    printf "[%s] Beginning crawl download\n" "$(date)"
    $CRIMEDB_ROOT/bin/crawl -vvvv \
        --data-dir=$CRIMEDB_ROOT/root/data \
        --work-dir=$CRIMEDB_ROOT/work \
        --config=$HOME/.crimedb/crawl_config \
        download
    printf "[%s] Finished crawl download\n" "$(date)"

    printf "[%s] Beginning crawl process\n" "$(date)"
    $CRIMEDB_ROOT/bin/crawl -vvvv \
        --data-dir=$CRIMEDB_ROOT/root/data \
        --work-dir=$CRIMEDB_ROOT/work \
        --config=$HOME/.crimedb/crawl_process_config \
        process
    printf "[%s] Finished crawl process\n" "$(date)"

    printf "[%s] Beginning crawl collate\n" "$(date)"
    $CRIMEDB_ROOT/bin/crawl -vvvv \
        --data-dir=$CRIMEDB_ROOT/root/data \
        --work-dir=$CRIMEDB_ROOT/work \
        --config=$HOME/.crimedb/crawl_config \
        collate
    printf "[%s] Finished crawl collate\n" "$(date)"
fi

if [[ -n "$optRender" ]] ; then
    printf "[%s] Beginning render\n" "$(date)"
    $CRIMEDB_ROOT/bin/render -vvvv \
        --time-from=$(date --date='January 1 2014' +'%s') \
        --time-to=$(date --date='January 1 2015' +'%s') \
        $CRIMEDB_ROOT/root/data $CRIMEDB_ROOT/www $CRIMEDB_ROOT/root/www
    printf "[%s] Finished render\n" "$(date)"
fi

if [[ -n "$optPush" ]] ; then
    printf "[%s] Beginning push\n" "$(date)"
    $CRIMEDB_ROOT/bin/push s3://www.crimedb.org s3://data.crimedb.org
    printf "[%s] Finished push\n" "$(date)"
fi
