#!/bin/env node
/*
 * Initialize a CouchDB instance with data from the St. Louis Police Department
 * via http://www.slmpd.org/Crimereports.shtml.
 *
 * XXX: Need to handle errors that don't have reason fields (e.g. those that
 *      come from somewhere other than CouchDB).
 *
 * XXX: The document queueing in importCSVFile is not interacting correctly
 *      with the callback, which gets invoked as soon as we're done parsing the
 *      CSV file. Instead, it should wait until we're done inserting docs.
 */

var console = require('console');
var crimedb_common = require('crimedb/common');
var crimedb_geo = require('crimedb/geo');
var csv = require('csv');
var optimist = require('optimist');
var strptime = require('micro-strptime').strptime;

/*
 * Import a CSV file into the given database.
 */
var importCSVFile = function(dbHandle, csvPath, callback) {
    var min = function(a, b) { return a > b ? b : a; };
    var cols = null;
    var docBatch = [];

    var transformXYCoord = function(idoc, odoc) {
        crimedb_geo.spcsToLatLong(
            2401, idoc['X-Coord'], idoc['Y-Coord'], 'us-ft',
            function(err, gjo) {
                if (err) {
                    callback(err);
                    return;
                }

                odoc['location'] = gjo;

                enqueueDoc(odoc);
            }
        );
    };

    var enqueueDoc = function(doc) {
        docBatch.push(doc);

        if (docBatch.length >= 10) {
            dbHandle.bulkDocs({docs: docBatch}, function(err) {
                if (err) {
                    callback(err);
                }
            });

            docBatch = [];
        }
    };

    csv().from(csvPath)
        .on('record', function(rec) {
            /* Grab the column names from the first record */
            if (!cols) {
                cols = rec;
                return;
            }

            /* Construct our object by mapping column names to values */
            var idoc = {};
            for (var i = 0; i < min(rec.length, cols.length); ++i) {
                idoc[cols[i]] = rec[i].trim();
            }

            /*
             * Perform transformations on our input data to well-kown formats.
             * Do synchronous transforms first, as it's easier.
             */
            var odoc = {};
            odoc['description'] = idoc['Description'];
            odoc['time'] =
                (strptime(idoc['Date Occured'], '%m/%d/%Y %H:%M')).getTime() /
                    1000;

            /* Perform asynchronous transformations */
            transformXYCoord(idoc, odoc);
        }).on('end', function(count) {
            if (docBatch.length > 0) {
                dbHandle.bulkDocs({docs: docBatch}, function(err) {
                    callback(err);
                });
            } else {
                callback(null);
            }
        }).on('error', function(err) {
            callback(err);
        });
};

/*
 * Import many CSV files into the given database.
 */
var importCSVFiles = function(dbHandle, csvPaths, callback) {
    if (csvPaths.length == 0) {
        callback(null);
        return;
    }

    var csvPath = csvPaths.shift();
    importCSVFile(dbHandle, csvPath, function(err) {
        if (err) {
            console.log('Error importing ' + csvPath);
            callback(err);
        } else {
            console.log('Successfully imported ' + csvPath);
            importCSVFiles(dbHandle, csvPaths, callback);
        }
    });
};

var opts = optimist.options({
    help: {
        alias: 'h',
        boolean: true,
        describe: 'show help'},
    couchdb: {
        default: 'http://localhost:5984/crimes',
        describe: 'the CouchDB instance to connect to'},
    clear: {
        boolean: true,
        describe: 'clear the database before importing'}})
    .usage('\
usage: $0 <path>\n\
\n\
Imports the file at <path> into the CouchDB database.\
').wrap(80);
var args = opts.argv;

if (args.h) {
    opts.showHelp(console.log);
    process.exit(0);
}

if (args._.length < 1) {
    console.error('missing required <path> argument\n');
    opts.showHelp();
    process.exit(1);
}

crimedb_common.getDB(args.couchdb, true, args.clear, function(err, dbHandle) {
    if (err) {
        throw Error(err.reason);
    }

    importCSVFiles(dbHandle, args._, function(err) {
        if (err) {
            throw err;
        }
    });
});

// vim:filetype=javascript
