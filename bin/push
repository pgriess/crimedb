#!/bin/bash
#
# Push the entire source tree to

optRestartHapi=
optCrimeDBDir=/opt/crimedb
optCrimeDBUser=root
optCrimeDBHost=www.crimedb.org

log() {
    echo >&2 "$(basename $0): $@"
}

die() {
    log $@
    exit 1
}

usage() {
    cat <<EOF
usage: $(basename $0) [options]

Push CrimeDB to the given destination, which should be a string of the form
[<user>@]<hostname>.

Options:
  -d <dir>                    push to the given directory on the destination
                              host (default: $optCrimeDBDir)
  -h                          display help
  -H <host>                   push to the given host (default: $optCrimeDBHost)
  -l <login>                  push as the given user (default: $optCrimeDBUser)
  -r                          restart Hapi (default: don't restart)
EOF
}

while getopts "d:hr" OPTOPT ; do
    case $OPTOPT in
        d)
            optCrimeDBDir=$OPTARG
            ;;

        h)
            usage
            exit 0
            ;;

        r)
            optRestartHapi=1
            ;;
    esac
done

shift $(($OPTIND - 1))

if [[ $# -ne 0 ]] ; then
    echo >&2 "$(dirname $0): skipping superfluous arguments: $@"
fi

rsync -rv \
    --exclude=/.git \
    --exclude=/solr/crime/data \
    $(dirname $0)/.. $optCrimeDBUser@$optCrimeDBHost:$optCrimeDBDir || \
    die "failed to rsync"

if [[ -n $optRestartHapi ]] ; then
    ssh $optCrimeDBHost 'sv restart /etc/service/hapi' || \
        die "failed to restart Hapi"
fi
